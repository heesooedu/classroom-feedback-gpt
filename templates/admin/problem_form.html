{% extends "base.html" %}
{% block title %}문제 {{ '수정' if problem else '생성' }} - 관리자{% endblock %}

{% block head_extra %}
  <!-- Ace Editor (관리자 정답 코드 입력용) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"
          crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="card">
  <h2>문제 {{ '수정' if problem else '생성' }}</h2>

  {% if problem %}
    <form method="post"
          action="{{ url_for('admin_problem_edit', problem_id=problem.id) }}">
  {% else %}
    <form method="post" action="{{ url_for('admin_problem_new') }}">
  {% endif %}

    <label class="label">제목</label>
    <input class="input" type="text" name="title"
           value="{{ problem.title if problem else '' }}" required>

    <label class="label">설명 (문제 본문)</label>
    <textarea class="input textarea" name="description" rows="5" required>
{{ problem.description if problem else '' }}</textarea>

    <label class="label">예시 입력</label>
    <textarea class="input textarea" name="sample_input" rows="3">
{{ problem.sample_input if problem and problem.sample_input else '' }}</textarea>

    <label class="label">예시 출력</label>
    <textarea class="input textarea" name="sample_output" rows="3">
{{ problem.sample_output if problem and problem.sample_output else '' }}</textarea>

    <label class="label">정답 예시 코드 (파이썬)</label>

    <!-- 실제 전송되는 textarea (숨겨짐, required 유지) -->
    <textarea class="input textarea code-textarea"
              id="answer_code"
              name="answer_code"
              rows="10"
              required
              style="display:none;">{{ problem.answer_code if problem else '' }}</textarea>

    <!-- 화면에 보이는 Ace 에디터 컨테이너 -->
    <div id="answer_editor" class="editor"></div>

    <label class="label">채점 기준 (루브릭)</label>
    <textarea class="input textarea" name="rubric" rows="4" required>
{{ problem.rubric if problem else '' }}</textarea>

    <label class="label">만점 점수</label>
    <input class="input" type="number" name="max_score" min="1"
           value="{{ problem.max_score if problem else 10 }}" required>

    <label class="label" style="margin-top:8px;">
      <input type="checkbox" name="is_open"
             {% if problem and problem.is_open %}checked{% endif %}>
      학생에게 공개
    </label>

    <button class="btn" type="submit" style="margin-top:12px;">
      저장
    </button>
    <a href="{{ url_for('admin_problem_list') }}" class="btn btn-secondary" style="margin-left:8px;">
      목록으로
    </a>
  </form>
</div>

<script>
  window.addEventListener("DOMContentLoaded", function() {
    const ta = document.getElementById("answer_code");
    const container = document.getElementById("answer_editor");

    if (typeof ace === "undefined") {
      console.warn("Ace editor not loaded. Using plain textarea for answer_code.");
      // Ace가 안 뜨면 textarea 다시 보이게
      ta.style.display = "block";
      return;
    }

    const editor = ace.edit("answer_editor");
    editor.session.setMode("ace/mode/python");
    editor.setTheme("ace/theme/github");
    editor.setOptions({
      fontSize: "20px",
      tabSize: 4,
      useSoftTabs: true,
      showPrintMargin: false
    });

    // 초기 코드 세팅
    const initialCode = ta.value && ta.value.trim().length > 0
      ? ta.value
      : "";
    editor.setValue(initialCode, -1);

    // Ace 내용이 바뀔 때마다 textarea와 동기화
    editor.session.on("change", function() {
      ta.value = editor.getValue();
    });
  });
</script>
{% endblock %}
